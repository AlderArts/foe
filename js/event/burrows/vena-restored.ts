import { EncounterTable } from "../../encountertable";
import { GAME, TimeStep } from "../../GAME";
import { Gui } from "../../gui";
import { IChoice } from "../../link";
import { IParse, Text } from "../../text";
import { Player } from "../player";
import { LagonDScenes } from "./lagon-defeated";
import { Vena } from "./vena";
import { VenaFlags } from "./vena-flags";

export namespace VenaRScenes {

	export function Approach() {
		const player: Player = GAME().player;
		const parse: IParse = {
			playername : player.name,
		};

		Text.Clear();

		const scenes = new EncounterTable();

		scenes.AddEnc(() => {
			Text.Add("Vena is currently on her knees in front of her throne, with two of her many sons standing before her. Even from your angle, it is easy to see that the lucky lapins are receiving an enthusiastic blowjob from their mother. Vena alternates between each throbbing cock with blatant appreciation, sometimes even sucking on both dicks at the same time.", parse);
			Text.NL();
			Text.Add("As you step closer, Vena stops her ministrations to look at you. As soon as she recognizes you, she smiles. <i>“Hello, [playername],”</i> she says, beaming as she wipes a strand of pre from her lips and waving at you.", parse);
			Text.NL();
			Text.Add("You return her greeting with your usual politeness.", parse);
			Text.NL();
			Text.Add("Vena then turns to her sons and get back on her feet. <i>“Sorry, my darlings. Mommy will continue later, okay?”</i> she says, patting them on their heads. They look disappointed, but nod all the same. <i>“I’m sure your sisters would be happy to help you finish, now get going. Mommy has to talk to the champion.”</i>", parse);
			Text.NL();
			Text.Add("At this, the bunnies dart away in the direction of the Pit, each of them casting you an envious glare as they pass by.", parse);
			Text.NL();
			Text.Add("<i>“So, what can I do for you, champion?”</i> she asks, sitting on her throne and crossing her legs.", parse);
		}, 1.0, () => true);
		scenes.AddEnc(() => {
			Text.Add("Vena is seated upon her husband’s former throne, moaning softly in pleasure. The shriller cries are coming from one of the matriarch’s daughters, who is seated firmly in her mother’s lap. With the way Vena’s legs are spread, you can easily make out that the daughter has Vena’s mammoth girl-dick buried almost to the hilt inside of her, stretching her out as she enthusiastically bucks and leaps upon it.", parse);
			Text.NL();
			Text.Add("Vena soon spots you, and moves down to grab her daughter’s hips, lifting her off her cock while the smaller lapin squeals in protest.", parse);
			Text.NL();
			Text.Add("<i>“Sorry, honey, mommy has to see to the champion now. I’ll be happy to fuck you again some other time, but for now you should go see one of your brothers,”</i> she says, nuzzling her daughter affectionately.", parse);
			Text.NL();
			Text.Add("The younger rabbit passes by you as she makes her way towards the Pit, giving you an envious glare as she passes by. You note a slight limp in her steps as she goes.", parse);
			Text.NL();
			Text.Add("<i>“So, what can I do for you, champion?”</i> Vena asks with a smile, wiping her cock clean with a rag and crossing her legs.", parse);
		}, 1.0, () => true);
		scenes.AddEnc(() => {
			Text.Add("Eyes half-closed and a blissful smile stretched across her face, Vena is leaning back in her throne. Tucked into the crook of either arm is a healthy baby lagomorph busily suckling at her huge milky breasts.", parse);
			Text.NL();
			Text.Add("Vena spots you and motions for you to get closer. Then she does the same for one of her daughters nearby.", parse);
			Text.NL();
			Text.Add("The lapin approaches her mother and takes the infant lapins, replacing her mother breastfeeding them. After a brief moment to assure they’re comfy, she leaves with her little siblings in hand.", parse);
			Text.NL();
			Text.Add("<i>“Hello, champion. What can I do for you?”</i> she asks, crossing her legs.", parse);
		}, 1.0, () => true);
		scenes.AddEnc(() => {
			Text.Add("Seated almost imperiously upon her throne, Vena sprawls back with a satisfied grin on her face. Not unrelated, two of her vast brood of daughters are currently on their knees before her, working together to eagerly polish her massive, still half-flaccid maleness with their tongues and breasts.", parse);
			Text.NL();
			Text.Add("As soon as she spots you, however, she has her daughters move away. Both lagomorphs look at you as if you had just pooped their party, then run past you to join their siblings in the Pit.", parse);
			Text.NL();
			Text.Add("<i>“Hello, champion. What brings you here?”</i> Vena asks with a smile. The head of her cock glistens invitingly toward you, but you shake off your distraction.", parse);
		}, 1.0, () => true);
		scenes.AddEnc(() => {
			Text.Add("Grunts and soft moans of pleasure fill your ears as you enter the throne room. The amazonian matriarch is squatting on her throne, head thrown back and eyes screwed shut in rapture as she bounces up and down. The form of the lucky son - or daughter - buried inside her cunt is completely smothered beneath her bountiful physique, only their legs jutting out from beneath her swollen balls betraying their presence.", parse);
			Text.NL();
			Text.Add("As soon as Vena spots you, though, she lifts off her child’s shaft and whispers something in their ear. The lagomorph nods and dashes past you to join their brothers and sisters in the Pit. By the time you turn to look back at Vena, she’s already sitting at her throne, cross-legged. <i>“Sorry about that. Anything I can do for you, champion?”</i>", parse);
		}, 1.0, () => true);
		scenes.AddEnc(() => {
			Text.Add("Vena is leaning back in her throne, shifted slightly to sprawl over one arm and rest on her hip. One leg is lifted into the air, allowing one of the lapin’s many progeny to shift her titanic hermhood out of the way and eat out her pussy. They seem to be doing a pretty good job of it, looking at the rapturous expression on Vena’s face.", parse);
			Text.NL();
			Text.Add("One long ear twitches at the sound of your entrance, prompting a pleasure-glazed eye to open. Vena stares at you blindly for a few moments, and then blinks, the wits returning to her expression. With a gentle yet authoritative push, she sends her child staggering slightly back, allowing her to fold her legs back together and shift into a properly upright position.", parse);
			Text.NL();
			Text.Add("<i>“I’m sorry, dearie, but mommy needs to speak to the champion. Why don’t you go and play with one of your sisters in the Pit?”</i> she suggests, petting her offspring gently on their head in consolement.", parse);
			Text.NL();
			Text.Add("The rabbit shoots you a rather envious glance, but nods and sprints off. As their little white tail vanishes into the gloom, Vena smiles at you proudly. <i>“Welcome, champion. What may I do for you?”</i>", parse);
		}, 1.0, () => true);
		scenes.AddEnc(() => {
			Text.Add("Vena is currently kneeling on the floor in front of her throne, being busily spit roasted by two of her offspring. One lucky lapin is nearly obscured by his - or maybe her - mother’s generous ass, thrusting away as if their life depends upon it. The other stands at Vena’s front, where she shamelessly gobbles down their dick.", parse);
			Text.NL();
			Text.Add("As Vena begins sliding back along her offspring’s cock, you enter her view. Her eyes light up and she keeps on withdrawing, popping wetly free of the rabbit dick and leaving strings of saliva behind to link it to her mouth. These break as she smiles, ignoring the disappointed squeak of her child.", parse);
			Text.NL();
			Text.Add("<i>“Why, [playername], hello! Sorry, if you’ll just give me a moment? Now, sweetie, mommy needs to talk with the champion, so you’ll have to stop that,”</i> she insists gently, looking over her shoulder at the still-thrusting form of her second child.", parse);
			Text.NL();
			Text.Add("When they don’t seem inclined to stop, Vena simply rolls her considerable bulk forward, pulling away off of her second partner’s cock and standing up. A squeak of protest echoes from behind her, and she turns partially to address her disappointed child.", parse);
			Text.NL();
			Text.Add("<i>“Now, now; you know mommy has other things to do. I’m sorry that I can’t let you fuck my ass some more, but that’s just how it is. Why don’t you fuck your brother instead while mommy and [playername] talk?”</i> she suggests.", parse);
			Text.NL();
			Text.Add("An excited squeal greets her words, and Vena’s second child darts out into view - it’s one of the herms you helped Ophelia create. Vena’s son lets out a nervous squeak and turns to flee, but is caught by his sister as she gleefully springs forward. The two siblings tumble over each other into a corner, each giggling playfully as they start to tussle to decide who gets to fuck who.", parse);
			Text.NL();
			Text.Add("Vena watches this display with a doting smile. <i>“Such loving siblings, aren’t they?”</i> she notes proudly, before settling herself back down upon her throne. Casually ignoring the sounds of her children fornicating, she smiles at you. <i>“Now then, what can I do for you?”</i>", parse);
		}, 1.0, () => true);
		scenes.AddEnc(() => {
			Text.Add("Vena has one of her children in her lap as you enter. It takes a few moments to sort things out, but you realize that the lagomorph is standing in their huge mother’s lap, avidly humping away at her huge tits. Vena’s hands squeeze the expanses of breastflesh, a lustfully maternal smile on her face as she does her best to manipulate the flowing boobage around her offspring’s member. Her own cock throbs as it rests against her spawn’s backside, matting their tail in her pre-cum.", parse);
			Text.NL();
			Text.Add("The matriarch spots you and smiles happily, waving a hand in greeting before leaning forward and whispering something in her child’s ear. Reluctantly, the lapin, one of her many sons, stops his thrusting and then clambers down from Vena’s lap. Pouting, he wanders off in the direction of the Pit.", parse);
			Text.NL();
			Text.Add("<i>“It’s always good to see you here, [playername]; how may I help?”</i> Vena asks politely.", parse);
		}, 1.0, () => true);
		scenes.AddEnc(() => {
			Text.Add("The hulking yet feminine form of Vena is practically overflowing out of her throne, one of her many daughters swept up in her arms. Such is the size difference that it looks sweet, rather than comical... well, completely comical. Somewhat less sweet is the fact Vena is patiently licking long ropes of semen from her daughter’s face, the flaccid and still dripping cock hanging over the throne’s seat suggesting where it came from.", parse);
			Text.NL();
			Text.Add("The lapin matriarch catches your eye as she slurps along her daughter’s chin, her expression clearly asking you to give her a minute. With a few more deft strokes of her tongue, she deems her daughter’s face sufficiently clean, smacking her lips appreciatively before helping her down out of the throne.", parse);
			Text.NL();
			Text.Add("<i>“There we are, sweetheart. Mommy is very impressed; you’re a wonderful little cocksucker, your brothers will be so happy with you!”</i> she chortles. <i>“Now, run along and play; mommy and the champion need to talk.”</i>", parse);
			Text.NL();
			Text.Add("The bunny nods her head with a pleased giggle and scurries away, whereupon Vena beckons you closer. <i>“Thank you for your patience, [playername]. Now, was there something I could help you with?”</i>", parse);
		}, 1.0, () => true);
		scenes.AddEnc(() => {
			Text.Add("Vena is seated upon her throne, legs spread so that the full impressiveness of her pillar-like priapus can be easily seen. One of her countless sons is standing before her with the air of a priest before his altar, lavishing worshipful praise upon his mother’s endowment with hands and lips. His hips buck occasionally, stroking his own impressive, if substantially smaller, prick against his mother’s.", parse);
			Text.NL();
			Text.Add("The matriarch of the Burrows moans appreciatively as her son’s lips close demurely around her glans, nursing the fat river of pre-cum flowing from it. She stretches out a hand and pets his hair gently.", parse);
			Text.NL();
			Text.Add("<i>“Oh, yes, you’re doing wonderful... but mommy has to talk to [playername] now, so why don’t you run along to the Pit and show your brothers and sisters what you’ve been practicing?”</i>", parse);
			Text.NL();
			Text.Add("The lagomorph seems a little reluctant, but he looks up at his mother and nods his agreement before scampering away. Vena watches him go with a maternal smile, idly stroking the spot on her cock where her son was kissing her. She directs her inquisitive gaze to you, clearly waiting to hear what you wanted.", parse);
		}, 1.0, () => true);
		scenes.AddEnc(() => {
			Text.Add("For once, Vena is seated alone upon her husband’s former throne, with none of her children-subjects in personal attendance. Instead, all of her attention is fixated upon a long, thick carrot she is holding in her hands. It’s a good quality orange one from some farmer’s yard, too, not one of those scrawny purple-black wild-ones, either.", parse);
			Text.NL();
			Text.Add("Vena certainly seems to recognize it as something to savor. Her eyes are closed in rapture as she runs her tongue along it in smooth, sensual strokes, polishing its surface with spit until it gleams in the dim light of the warren. Opening her mouth, she slowly swallows it halfway down, moaning in delight around the orifice-stretching object.", parse);
			Text.NL();
			Text.Add("She pushes it deeper and deeper, until it seems like the whole six or so inches is about to disappear down her gullet, then withdraws it with a sigh. Smacking her lips, she opens her eyes absently.", parse);
			Text.NL();
			Text.Add("When she spots you, her eyes open wider and smiles. <i>“Oh! Why, hello, [playername]. Excuse me, I was just about to enjoy a snack. Is there something that you wanted?”</i>", parse);
		}, 1.0, () => true);

		scenes.Get();

		Text.Flush();

		VenaRScenes.Prompt();
	}

	export function Prompt() {
		const vena: Vena = GAME().vena;
		const parse: IParse = {

		};

		const options: IChoice[] = [];

		const judged = vena.flags.Met & VenaFlags.Met.Judgement;
		if (!judged) {
			options.push({nameStr : "Lagon’s fate",
				tooltip : Text.Parse("You want to talk about what’s going to happen to Lagon.", parse),
				enabled : true,
				func() {
					vena.flags.Met |= VenaFlags.Met.Judgement;

					Text.Clear();
					Text.Add("As delicately as you can, you reply that you were wondering what she’s going to do with the former king.", parse);
					Text.NL();
					Text.Add("The lagomorph queen takes on a grim expression. <i>“Yes, we need to discuss what to do with my husband. Lagon did many things that hurt our family, and others too. He must not be allowed to do so again.”</i>", parse);
					Text.NL();
					Text.Add("A strange way of putting it; it sounds almost like she hasn’t decided yet. Intrigued, you ask what she means by ‘we need to discuss it’.", parse);
					Text.NL();
					Text.Add("<i>“Well, truth be told, I’m not sure what to do,”</i> she says in a small voice. <i>“My mate must be punished so that he can’t wreak more havoc… but at the same time, I don’t want to hurt him either. Things can’t go on this way either; all my children are still terrified of him, despite him being locked away.”</i>", parse);
					Text.NL();
					Text.Add("For all that he did to her, it’s obvious that the futazonian rabbit queen still dearly loves her husband, in her own peculiar way. You feel a momentary pang of sympathy for Vena, to be put into such a position, which is quickly washed aside by a wave of outrage at Lagon. Didn’t the asshole realize what he had with her?", parse);
					Text.NL();
					Text.Add("<i>“What do <b>you</b> think should be done about him? Without your help, my mate would still be king, so I thought I’d hear your opinion on the matter.”</i> She looks at you hopefully, clearly torn.", parse);
					Text.NL();
					Text.Add("You take a moment to remind yourself of all that Lagon has done. Drugging his wife, terrorizing and raping his own children, attacking travelers and innocents and being a stupendous jerk about all of it. With a feeling of righteous indignation, you bend your thoughts to considering the options. You aren’t sure just how well Vena will like your suggestion, but she did ask for your thoughts...", parse);
					Text.Flush();

					TimeStep({minute: 5});

					VenaRScenes.LagonsFate({});
				},
			});
		}
		/* TODO
		options.push({nameStr : "",
			tooltip : Text.Parse("", parse),
			enabled : true,
			func : () => {
				Text.Clear();
				Text.Add("", parse);
				Text.NL();
				Text.Add("", parse);
				Text.Flush();
			}
		});
		*/
		Gui.SetButtonsFromList(options, true, () => {
			Text.Clear();
			Text.Add("You thank the matriarch for her time, telling her you have to be on your way.", parse);
			Text.NL();
			Text.Add("<i>“Do return soon, champion,”</i> Vena replies sincerely. She glances around at the growing gathering of her children around the throne. <i>“Meanwhile, it seems I have other ‘petitions’ to take care of...”</i> The lagomorph queen smiles apologetically.", parse);
			Text.Flush();

			TimeStep({minute: 5});

			Gui.NextPrompt();
		});
	}

	interface ILagonsFateOpts {
		kill?: boolean;
		exile?: boolean;
		drug?: boolean;
	}

	export function LagonsFate(opts: ILagonsFateOpts) {
		const player: Player = GAME().player;
		const parse: IParse = {
			playername : player.name,
		};

		const options: IChoice[] = [];
		// [Public Fuck][Kill Him][Exile][Drug Him]

		options.push({nameStr : "Public Fuck",
			tooltip : Text.Parse("What better way to break his power than a public humiliation?", parse),
			enabled : true,
			func() {
				Text.Clear();
				Text.Add("You run the scenario over in your head, smirking to yourself as you nod in satisfaction. Yes, this idea feels perfect; a punishment worthy of the crimes, and yet also merciful enough that it should make Vena happy.", parse);
				Text.NL();
				Text.Add("Looking at the lagomorph queen, you tell her that you think the best punishment for Lagon would be for her to have the whole warren watch him get fucked like a little bitch. Let them see that their terrible king is no more, and all that’s left is another bunny, just like them.", parse);
				Text.NL();
				Text.Add("Vena doesn’t seem too put off by your suggestion. <i>“Yes, I suppose that’s fair. I take it he was pretty cruel with our kids?”</i>", parse);
				Text.NL();
				Text.Add("Enough that they’re all still scared of him, even now that he’s been reduced to a shadow of his former self, you reply. This would be an excellent way of showing everyone that he no longer has the power to threaten them in any way.", parse);
				Text.NL();
				Text.Add("<i>“Alright, I can support that plan.”</i> Vena smiles. <i>“But what do we do afterwards? We just let him go?”</i>", parse);
				Text.NL();
				Text.Add("You quickly shake your head to that suggestion. Letting him go would be a big mistake. You suggest that she keep him under house arrest - give him a private room to himself and make him stay in there unless she wants him to be let out for something. Like to see how much of her cock she can squeeze into him.", parse);
				Text.NL();
				Text.Add("<i>“Yes, I suppose letting him go after all he did is a bit much. Alright then. I’m fine with this plan.”</i> The amazonian lagomorph turns to one of her sons. <i>“Darling, please go to the Pit and have everyone stop for a moment, let everyone know that it’s time their father paid for his crimes.”</i>", parse);
				Text.NL();
				Text.Add("The smaller bunny nods enthusiastically before darting away.", parse);
				Text.NL();
				Text.Add("Vena then turns to one of her guards. <i>“Fetch my husband and bring him to the Pit, don’t be too rough on your poor father, dear.”</i> The rabbit-guard salutes his queen and goes away to carry out her bidding.", parse);
				Text.NL();
				Text.Add("Next, Vena turns to look at you. <i>“Let’s go then, champion.”</i> She offers you her hand.", parse);
				Text.NL();
				Text.Add("You calmly reach out and clasp her hand, then allow her to lead the way from the throne room.", parse);
				Text.Flush();

				TimeStep({minute: 15});

				Gui.NextPrompt(() => {
					LagonDScenes.Punishment();
				});
			},
		});
		if (!opts.kill) {
			options.push({nameStr : "Kill him",
				tooltip : Text.Parse("It’s the easiest way to end his threat once and for all.", parse),
				enabled : true,
				func() {
					Text.Clear();
					Text.Add("Finally, you shrug your shoulders and calmly tell Vena that, in her place, knowing what Lagon did to her and to her children, you’d have him executed.", parse);
					Text.NL();
					Text.Add("<i>“Executed!? No!”</i> The reply is quick and indignant.", parse);
					Text.NL();
					Text.Add("You give Vena a deep, soul-searching look, quietly suppressing any surprise you may feel. After a few moments, she is compelled to break the silence.", parse);
					Text.NL();
					Text.Add("<i>“I mean… I can’t just have my husband killed. Despite everything that he has done… I still love him dearly.”</i> Her words are soft, but from the look in her eyes you can tell that she’s never going to budge on this; she’d rather see herself subjugated again than to make Lagon pay for his crimes with his life.", parse);
					Text.NL();
					Text.Add("You sigh and nod your understanding. Quietly, you tell Vena that Lagon really doesn’t deserve a wife like her - he clearly had no idea what sort of woman he’d married. But if she really wants to preserve his life, you’ll think of some other punishment.", parse);
					Text.Flush();
					opts.kill = true;

					TimeStep({minute: 5});

					VenaRScenes.LagonsFate(opts);
				},
			});
		}
		if (!opts.exile) {
			options.push({nameStr : "Exile",
				tooltip : Text.Parse("Banishing him from the burrows would be the cruellest kindness you can offer.", parse),
				enabled : true,
				func() {
					Text.Clear();
					Text.Add("After a moment’s thought, you tell Vena that if Lagon seems to think so little of his family, then the best punishment would be to send him away. See if being all alone out there makes him realize how wrong he was to mistreat his kin so badly.", parse);
					Text.NL();
					Text.Add("<i>“I suppose that would be a fitting punishment, but aren’t you afraid he might just make trouble somewhere else?”</i>", parse);
					Text.NL();
					Text.Add("Though your first reaction is to dismiss Lagon as harmless - he’s just a bunny now, after all - you stop a moment and think. It’s true Lagon’s no longer a physical powerhouse, but he’s still very intelligent. Vena’s right; if allowed to leave, there’s nothing to stop him from cooking up some other scheme, maybe trying to breed a rival clan of bunnies to come back and conquer his old family.", parse);
					Text.NL();
					Text.Add("<i>“Besides… no. I have things I want to talk with him about, and I don’t really wish him to be gone...”</i> She trails off.", parse);
					Text.NL();
					Text.Add("Sighing softly, you confess that Vena is right; on reflection, exile would be a poor decision to make. You’ll try and think of a better punishment for him instead.", parse);
					Text.Flush();
					opts.exile = true;

					TimeStep({minute: 5});

					VenaRScenes.LagonsFate(opts);
				},
			});
		}
		if (!opts.drug) {
			options.push({nameStr : "Drug him",
				tooltip : Text.Parse("Giving him a taste of his own medicine should work wonders.", parse),
				enabled : true,
				func() {
					Text.Clear();
					Text.Add("Smirking at the irony, you suggest to Vena that since Lagon was so eager to drug her and their children, it would be a fitting punishment indeed to dose him with some drugs in turn.", parse);
					Text.NL();
					Text.Add("<i>“Well, I suppose there are crueler fates, but still...”</i>", parse);
					Text.NL();
					Text.Add("You point out that Lagon didn’t hesitate in the slightest to drug her in order to seize power, or to use her and their children as guinea pigs for his latest concoctions. It’s certainly a case of fitting the punishment to the crime.", parse);
					Text.NL();
					Text.Add("<i>“I see your point, but wouldn’t we be just as bad as my husband was if we do that? To be honest, I don’t find the idea of drugging him - or anybody else - to be a good idea. Especially because I was drugged before. It’s horrible!”</i>", parse);
					Text.NL();
					Text.Add("You point out that you weren’t suggesting she take it to the same extent that her husband did. Something more like giving him a big pair of tits of his own for the kids to play with, or a cum-thirsty womb of his own to handle, not reducing him to a mindless fuck-toy like she was.", parse);
					Text.NL();
					Text.Add("<i>“I’m sorry, [playername], but I can’t condone this as a punishment. I’m sure there’s something else we can do that’s not as cruel, but drives the point home.”</i>", parse);
					Text.NL();
					Text.Add("You’re not blind to the steel under that soft, fluffy exterior. With a soft sigh of defeat, you tell her that you’ll try and think of something else to punish Lagon with.", parse);
					Text.Flush();
					opts.drug = true;

					TimeStep({minute: 5});

					VenaRScenes.LagonsFate(opts);
				},
			});
		}

		Gui.SetButtonsFromList(options, false, undefined);
	}
}
